---
title: "Next.jsã«Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚’å°å…¥ã™ã‚‹"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['nextjs']
published: false
---

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³

Next.js 12.0.7
Google ã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ 4

# Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹

Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã¨ã¯

https://marketingplatform.google.com/intl/ja/about/analytics/features/

# Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã¨ãƒ‡ãƒ¼ã‚¿åé›†ã™ã‚‹ãŸã‚ã®IDã‚’å–å¾—ã™ã‚‹

Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã¯ã€ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿åé›†ã€åˆ†æã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€ã¾ãšã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚å…¬å¼ã®ãƒ˜ãƒ«ãƒ—ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ–¹æ³•ã‚„ãƒ‡ãƒ¼ã‚¿åé›†ã®ãŸã‚ã«å¿…è¦ãªIDå–å¾—ã®æ‰‹é †ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã“ã§å–å¾—ã—ãŸIDã‚’ä½¿ã£ã¦Next.jsã‹ã‚‰Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¾ã™ã€‚

https://support.google.com/analytics/answer/9304153

Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€IDã£ã½ã„ã‚‚ã®ãŒã„ãã¤ã‹ã‚ã£ã¦ã©ã‚ŒãŒå¿…è¦ãªã‚‚ã®ãªã®ã‹è¿·ã„ã‚„ã™ã„ã§ã™ãŒã€ä»¥ä¸‹ç”»é¢ã‚­ãƒ£ãƒ—ãƒãƒ£ã®IDã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a00e219eba78-20220111.png)

# Next.jsã§Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹

Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å´ã®æº–å‚™ãŒã§ããŸã‚‰Next.jså´ã®è¨­å®šã‚’ãŠã“ãªã„ã¾ã™ã€‚å¿…è¦ãªã“ã¨ã¯ä»¥ä¸‹ã§ã™ã€‚

:::details Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®IDã‚’Next.jsã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã™ã‚‹

- Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹å´ã§ç™ºè¡Œã—ãŸãƒ‡ãƒ¼ã‚¿åé›†ã™ã‚‹ã¨ãã«ä½¿ã†IDã‚’ã€Next.jsã®ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èª­ã¿è¾¼ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
- .env.local

```
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=hogehoge
```

:::

:::details ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ãªã©GAã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹é–¢æ•°ã‚’ä½œã‚‹

- ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ãªã©GAã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹é–¢æ•°ã‚’ä½œã‚Šã¾ã™ã€‚
- src/libs/gtag.ts

```typescript
export const GA_ID = process.env.NEXT_PUBLIC_GOOGLE_ANALYTICS_ID;

export const existsGaId = GA_ID !== '';

// PVã‚’æ¸¬å®šã™ã‚‹
export const pageView = (
  path: string,
  { shallow = false }: { shallow?: boolean }
) => {
  if (
    !existsGaId ||
    typeof GA_ID === 'undefined' ||
    !('gtag' in window) ||
    shallow
  ) {
    return;
  }    

  window.gtag('event', 'page_view', {
    page_path: path,
    send_to: GA_ID,
  });
};

```

- gtagã¯ã€æ¸¬å®šã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹ã€JavaScript ã®ã‚¿ã‚°è¨­å®šãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ãŠã‚ˆã³ API ã§ã™ã€‚
  - https://developers.google.com/tag-platform/gtagjs?hl=ja
- gtagã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã¡ã‚‰ã¯å¾Œè¿°ã—ã¾ã™ã€‚
- gtagã®å¼•æ•°ã«page_viewãªã©ãŒæŒ‡å®šã—ã¦ã„ã¾ã™ãŒã€ã“ã¡ã‚‰ã¯pave_viewã‚¤ãƒ™ãƒ³ãƒˆã‚’GAã«é€ä¿¡ã—ã¦ã„ã¾ã™ã€‚GAã§åé›†ã—ãŸã„ãƒ‡ãƒ¼ã‚¿ã¯ã€ã“ã®ã‚ˆã†ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã¦å–å¾—ã§ãã¾ã™ã€‚
  - https://developers.google.com/analytics/devguides/collection/ga4/page-view?hl=ja
- ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ãªã©GAã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã•ã›ã‚‹é–¢æ•°ã‚’å®Ÿè¡Œã•ã›ã‚‹å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç”Ÿã•ã›ã‚‹ã®ã§ã€Routerã®URLæ›¸ãæ›ãˆãŒå®Œäº†ã—ãŸæ™‚ã«ç™ºç«ã™ã‚‹ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚
- src/hooks/libs/usePageView.ts

```typescript
import { useEffect } from 'react';
import { useRouter } from 'next/router';
import { existsGaId, pageView } from '../../libs/gtag';

export const usePageView = () => {
  const router = useRouter();

  useEffect(() => {
    if (!existsGaId) {
      return () => {};
    }

    router.events.on('routeChangeComplete', pageView);
    return () => router.events.off('routeChangeComplete', pageView);
  }, [router.events]);
};
```

:::

:::details Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚€
- gtagãªã©ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
- src/components/GoogleAnalytics/GoogleAnalytics.tsx

```typescript
import Script from 'next/script';
import { existsGaId, GA_ID } from '../../libs/gtag';

export const GoogleAnalytics = () => {
  if (existsGaId) {
    return (
      <>
        <Script
          defer
          src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}
          strategy="afterInteractive"
        />
        <Script id="ga" defer strategy="afterInteractive">
          {`
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());    
                  gtag('config', '${GA_ID}');
              `}
        </Script>
      </>
    );
  }

  return null;
};
```

- GoogleAnalyticsã¨usePageViewã‚’_app.tsxã§èª­ã¿è¾¼ã¿ã¾ã™

```typescript
const MyApp: NextPage<AppProps> = ({ Component }) => {
  usePageView();
  return (
    <>
      <GoogleAnalytics />
      <ChakraProvider theme={theme}>
          <Component />
      </ChakraProvider>
    </>
  );
};
```

:::

:::details types/gtag.js ã‚’å°å…¥ã—ã¦å‹å®šç¾©ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹

- å‹å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ãŸã‚ã€src/libs/gtag.tsã®window.gtag ã®å‡¦ç†ã§å‹å®šç¾©ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
- ä»¥ä¸‹ã®å®šç¾©ã‚’å°å…¥ã™ã‚‹ã¨è§£æ¶ˆã§ãã¾ã™ã€‚

```bash
$ yarn add -D  @types/gtag.js
```
:::

ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå¤§å¤‰ä¸å¯§ã§å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

https://panda-program.com/posts/nextjs-google-analytics


Next.jsã®Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã®example

https://github.com/vercel/next.js/tree/canary/examples/with-google-analytics


# åé›†ã§ããŸ

![](https://storage.googleapis.com/zenn-user-upload/02d4c3279f90-20220111.png)

# ãŠã‚ã‚Šã«

Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€å°å…¥å¾Œã¡ã‚ƒã‚“ã¨å€¤å–ã‚Œã¦ã‚‹ã‹ç¢ºèªã™ã‚‹éš›ã«ã€åŸºæœ¬ã†ã¾ãã„ã£ã¦ãã†ã ã‘ã©ã€ãŸã¾ã«å€¤å–ã‚Œã¦ãªã„ï¼Ÿã¨ã„ã†ã‹ã€ã©ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒ‡ãƒ¼ã‚¿é€ã£ã¦ã‚‹ã®ã‹ã‚ã‹ã‚‰ãªãã¦ã€ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ¼ã‚¿é…ã‚Œã¦ã‚‹ã‹ä¸å®‰ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€Googleã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹è‡ªä½“ã‚’ä»Šåº¦èª¿ã¹ã¦ã¿ã‚‹ã€‚