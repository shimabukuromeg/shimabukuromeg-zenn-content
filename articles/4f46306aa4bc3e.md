---
title: "NestJS + Prisma ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Github Actions ã§GCPç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã"
emoji: "ğŸ‘¨ğŸ¼â€ğŸ’»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["githubactions", "nestjs", "prisma", "gcp"]
published: true
publication_name: "monicle"
---

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯ã€NestJS ã¨ Prisma ã§ä½œã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€Github Actions ã‚’åˆ©ç”¨ã—ã€GCPç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã§ã®æµã‚Œã‚’ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚
ä¼¼ãŸã‚ˆã†ãªç’°å¢ƒã‚’æ§‹ç¯‰ã—ã‚ˆã†ã¨ã™ã‚‹éš›ã«å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

**ã“ã®è¨˜äº‹ã§ã‚„ã‚‹ã“ã¨**

- ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™ï¼ˆnestjsã€prismaï¼‰
- GCPãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆï¼ˆterraformï¼‰
- Github Actionsã®è¨­å®š

æ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã€Cloud Run ã¨ Cloud SQL ã‚’ä½¿ã£ãŸã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆã®ç’°å¢ƒã§ã™ã€‚

**æ§‹æˆ**

![ã‚¤ãƒ¡ãƒ¼ã‚¸å›³](https://storage.googleapis.com/zenn-user-upload/c8c73bbb6e70-20230108.png)

:::details æ§‹æˆã‚’è€ƒãˆãŸæ™‚ã«å‚è€ƒã«ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¾ã¨ã‚
- Cloud SQLã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã§ä½¿ã†æ–¹æ³•
    - å›³ãŒã¾ã¨ã¾ã£ã¦ã‚‹
        - [ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã®ä½¿ç”¨æ–¹æ³•ã®è©³ç´° Â \|Â  Cloud SQL for PostgreSQL Â \|Â  Google Cloud](https://cloud.google.com/sql/docs/postgres/private-ip?hl=ja)
    - å®Ÿéš›ã®æ§‹ç¯‰æ‰‹é †ãŒã¾ã¨ã¾ã£ã¦ã‚‹
        - [ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚’æ§‹æˆã™ã‚‹ Â \|Â  Cloud SQL for PostgreSQL Â \|Â  Google Cloud](https://cloud.google.com/sql/docs/postgres/configure-private-ip?hl=ja)

- CloudRunã‹ã‚‰VPCã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ–¹æ³•
    - å›³ã§ã¾ã¨ã¾ã£ã¦ã‚‹
        - [ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ VPC ã‚¢ã‚¯ã‚»ã‚¹ Â \|Â  Google Cloud](https://cloud.google.com/vpc/docs/serverless-vpc-access?hl=ja)
    - å®Ÿéš›ã®æ§‹ç¯‰æ‰‹é †ãŒã¾ã¨ã¾ã£ã¦ã‚‹
        - [ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ VPC ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ§‹æˆã™ã‚‹ Â \|Â  Google Cloud](https://cloud.google.com/vpc/docs/configure-serverless-vpc-access?hl=ja)

- [ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ: Cloud Run ã‹ã‚‰ Cloud SQL for PostgreSQL ã«æ¥ç¶šã™ã‚‹ Â \|Â  Google Cloud](https://cloud.google.com/sql/docs/postgres/connect-instance-cloud-run?hl=ja)
:::



# ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™

ã¾ãšã¯ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã«ã€NestJS ã¨ Prisma ãŒå‹•ãã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”¨æ„ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æº–å‚™ã—ã¾ã—ãŸã€‚ï¼ˆ`/posts` ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ post ã®ãƒªã‚¹ãƒˆãŒè¿”ã‚‹ã ã‘ã®ç°¡å˜ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ï¼‰

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ãã¾ã™ã€‚

https://github.com/shimabukuromeg/nestjs-prisma-sample/tree/sample-app

:::details å‹•ä½œç¢ºèª

æ‰‹å…ƒã®ç’°å¢ƒï¼ˆMacï¼‰ã§å‹•ã‹ã™å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```bash
$ docker compose up -d
$ yarn prisma migrate reset
$ yarn start:dev
```

åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‚’é–‹ã„ã¦ã€postsã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ãã¨ migration reset ã§ç™»éŒ²ã•ã‚ŒãŸ seed ã®ãƒ‡ãƒ¼ã‚¿ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã¾ã™ã€‚
```
$ curl http://localhost:3000/posts
[{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0e","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼‘","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"},{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0b","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼’","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"},{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0c","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼“","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"}]%
```
:::


CloudRunã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã«å¿…è¦ã¨ãªã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹Dockerfileã‚‚ç”¨æ„ã—ã¾ã™ã€‚

https://github.com/shimabukuromeg/nestjs-prisma-sample/blob/sample-app/Dockerfile

:::details Dockerfile

- `Dockerfile`

```
#==================================================
# Build Layer
FROM --platform=linux/amd64 node:18 as build

WORKDIR /app

COPY package.json yarn.lock ./

COPY prisma ./prisma

RUN yarn install --non-interactive --frozen-lockfile

RUN yarn prisma generate

COPY . .

RUN yarn build

#==================================================
# Package install Layer
FROM --platform=linux/amd64 node:18 as node_modules

WORKDIR /app

COPY package.json yarn.lock ./

COPY prisma ./prisma

RUN yarn install --non-interactive --frozen-lockfile --prod

RUN yarn prisma generate

#==================================================
# Run Layer
FROM --platform=linux/amd64 node:18-slim as node

WORKDIR /app

ENV NODE_ENV=production

COPY --from=build /app/dist /app/dist
COPY --from=build /app/prisma /app/prisma
COPY --from=node_modules /app/package.json /app/yarn.lock ./
COPY --from=node_modules /app/node_modules /app/node_modules

CMD ["/usr/local/bin/yarn", "start:prod"]
```

- `.dockerignore`

```
.git/
dist/
node_modules/
.env
```
:::


å‚è€ƒè¨˜äº‹

https://zenn.dev/jrsyo/articles/e42de409e62f5d

# GCPã®ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

ç¶šã„ã¦ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ terraform ã§ä½œæˆã—ã¾ã™ã€‚

CloudRunã‚„DBã€IAMã€ãªã©ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

**ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹**

- Artifact Registry
- VPC
- VPC Access Connector
- CloudSQL
- CloudRun
- IAM
- Workload Identityï¼ˆGitHub Actions ã‹ã‚‰ OIDC ã‚’ä½¿ç”¨ã—ã¦ èªè¨¼ã‚’è¡Œã†éš›ã«åˆ©ç”¨ï¼‰

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ä¸Šè¨˜ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ãŸHCLã‚’ç”¨æ„ã—ã¾ã—ãŸã€‚ã“ã®å®šç¾©ã‚’ä½¿ã£ã¦ç’°å¢ƒã‚’ä½œã‚Šã¾ã™ã€‚

:::details ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†æŠœç²‹ï¼ˆmain.tfï¼‰

- main.tf ï¼ˆè©³ç´°ã¯ãƒªãƒã‚¸ãƒˆãƒªå‚ç…§ï¼‰

```
provider "google" {
  project = var.project_id
  region  = var.region
  zone    = var.zone
}

# APIã®æœ‰åŠ¹åŒ–
module "service" {
  source     = "./modules/service"
  project_id = var.project_id
}

# Artifact Registry
module "artifact_registry" {
  source        = "./modules/artifact_registry"
  project_id    = var.project_id
  location      = var.region
  repository_id = "my-repo"

  depends_on = [
    module.service
  ]
}

module "vpc" {
  source     = "./modules/vpc"
  project_id = var.project_id
  region     = var.region

  depends_on = [
    module.service
  ]
}

module "cloud_sql" {
  source        = "./modules/cloud_sql"
  project_id    = var.project_id
  region        = var.region
  db-network-id = module.vpc.vpc_id

  depends_on = [
    module.vpc,
    module.service
  ]
}

resource "random_id" "pool_id_suffix" {
  byte_length = 4
}

module "workload_identity" {
  source     = "./modules/workload_identity"
  project_id = var.project_id
  region     = var.region
  pool_id    = "my-pool-${random_id.pool_id_suffix.hex}"

  depends_on = [
    module.service
  ]
}

module "iam" {
  source     = "./modules/iam"
  project_id = var.project_id
  region     = var.region
  pool_id    = module.workload_identity.workload_identity_provider_pool.name
  repository = var.repository

  depends_on = [
    module.workload_identity,
    module.service
  ]
}

module "cloud_run" {
  source                  = "./modules/cloud_run"
  project_id              = var.project_id
  region                  = var.region
  vpc_access_connector_id = module.vpc.vpc_access_connector_id
  db_connection_name      = module.cloud_sql.db_connection_name
  service_account_name    = module.iam.cloud_run_sa_service_account_name

  depends_on = [
    module.iam,
    module.service
  ]
}
```
:::

https://github.com/shimabukuromeg/nestjs-prisma-gcp-terraform


:::details terraform ã®ç’°å¢ƒæ§‹ç¯‰æ–¹æ³•
- GCPã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
- GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹ï¼ˆèª²é‡‘ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼‰
https://cloud.google.com/billing/docs/how-to/modify-project?hl=ja
- Google Cloud CLI ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
https://cloud.google.com/sdk/docs/downloads-interactive?hl=ja
```bash
$ curl https://sdk.cloud.google.com | bash
$ exec -l $SHELL
$ gcloud init
$ gcloud version
```
- Terraform ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
$ brew install tfenv
$ tfenv --version
$ tfenv install 1.3.0
$ tfenv use 1.3.0
$ terraform version
```

:::

`terraform.tfvars` ã« GCPã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDãªã©ã®æŒ‡å®šã‚’ã—ã¦ã‚ã’ãŸã®ã¡ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# ç’°å¢ƒå¤‰æ•°ã‚’æŒ‡å®šã™ã‚‹
$ cp terraform.tfvars.example terraform.tfvars
$ terraform plan
$ terraform apply
```


å‚è€ƒè¨˜äº‹

terraformæ›¸ãã¯ã˜ã‚ã®æ›¸ãæ–¹ã‚’ã‚ˆãå¿˜ã‚Œã‚‹ã®ã§ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸ã‚’å‚è€ƒ

https://developer.hashicorp.com/terraform/tutorials/gcp-get-started/google-cloud-platform-build

GCPã®å„ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒšãƒ¼ã‚¸ã« terraform ã®å®šç¾©ãŒæ›¸ã„ã¦ã‚‹ã“ã¨ãŒå¤šã„ã®ã§ãã®è¾ºã‚Šã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

å‰ã« terraform ã®æ›¸ãæ–¹èª¿ã¹ãŸè¨˜äº‹

https://zenn.dev/monicle/articles/1aada9da2e742b

# Github Actionsã®è¨­å®š

ç¶šã„ã¦ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã¦ã„ãã¾ã™ã€‚

### GCP èªè¨¼

Github Actions ã‹ã‚‰ GCPã¸ã®èªè¨¼ã« google-github-actions/auth ã‚’ä½¿ã„ã¾ã™ã€‚

https://github.com/google-github-actions/auth

GitHub Actions ã¯ OpenID ConnectãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚Šã€ã“ã®ä»•çµ„ã¿ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãŒãªãã¦ã‚‚ GithubActionsã‹ã‚‰GCPã¸èªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

https://christina04.hatenablog.com/entry/workload-identity-federation

### ãƒ“ãƒ«ãƒ‰

ä»¥ä¸‹ã€NestJSã¨Prisma ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€Artifact Registry ã« Push ã™ã‚‹ã¾ã§ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®šç¾©ã§ã™ã€‚

:::details `.github/workflows/build-image.yml`
- `.github/workflows/build-image.yml`

```yml
name: Build

on:
  workflow_call:
    secrets: # workflow_call ã®æ™‚ã« secrets ã®æ‰±ã„ã«è‹¥å¹²ãƒãƒã£ãŸ https://docs.github.com/ja/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecrets
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      SERVICE_ACCOUNT:
        required: true
      IMAGE_TAG_BASE:
        required: true

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

env:
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
  SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
  IMAGE_HOST: "asia-northeast1-docker.pkg.dev"
  IMAGE_TAG_BASE: ${{ secrets.IMAGE_TAG_BASE }} # ä¾‹. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID/artifact_registryå/ã‚¤ãƒ¡ãƒ¼ã‚¸å

jobs:
  build-push:
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: Docker Setup
        id: buildx
        uses: docker/setup-buildx-action@v2

      - name: Authorize Docker push
        id: authorize-docker-push
        shell: bash
        run: gcloud auth configure-docker ${{ env.IMAGE_HOST }}

      - name: Docker Image Build and Push
        id: docker-build
        uses: docker/build-push-action@v3
        with:
          push: true
          provenance: false
          tags: "${{ env.IMAGE_HOST }}/${{ env.IMAGE_TAG_BASE }}:latest"
          build-args: |
            APP_VERSION=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```
:::



### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ & ãƒ‡ãƒ—ãƒ­ã‚¤

ä»¥ä¸‹ã€Prisma ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã€ NestJSã€Prismaã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ CloudRun ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã§ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®šç¾©ã§ã™ã€‚

:::details `.github/workflows/deploy-to-cloud-run.yml`

- `.github/workflows/deploy-to-cloud-run.yml`

```yml
name: Deploy to Cloud Run

on:
  workflow_call:
    secrets: # workflow_call ã®æ™‚ã« secrets ã®æ‰±ã„ã«è‹¥å¹²ãƒãƒã£ãŸ https://docs.github.com/ja/actions/using-workflows/workflow-syntax-for-github-actions#onworkflow_callsecrets
      WORKLOAD_IDENTITY_PROVIDER:
        required: true
      SERVICE_ACCOUNT:
        required: true
      RUN_SERVICE_ACCOUNT:
        required: true
      PROJECT_ID:
        required: true
      IMAGE_TAG_BASE:
        required: true
      DATABASE_URL:
        required: true

concurrency:
  group: "${{ github.workflow }}-${{ github.head_ref || github.ref }}"
  cancel-in-progress: true

env:
  PROJECT_ID: ${{ secrets.PROJECT_ID }}
  WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
  SERVICE_ACCOUNT: ${{ secrets.SERVICE_ACCOUNT }}
  RUN_SERVICE_ACCOUNT: ${{ secrets.RUN_SERVICE_ACCOUNT }}
  VPC_CONNECTOR: "vpc-con"
  GCP_REGION: asia-northeast1
  GCP_CLOUD_RUN_SERVICE_NAME: "api"
  IMAGE_HOST: "asia-northeast1-docker.pkg.dev"
  IMAGE_TAG_BASE: ${{ secrets.IMAGE_TAG_BASE }}
  DATABASE_URL: ${{ secrets.DATABASE_URL }}

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checktout
        uses: actions/checkout@v3

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'
        with:
          install_components: 'beta'

      - name: "Run migration"
        id: migrate
        run: |
            gcloud config set run/region $GCP_REGION
            set +e
            gcloud beta run jobs describe migration --quiet >/dev/null
            job_exists_check=$?
            set -e
            if [ $job_exists_check -eq 0 ]; then
              jobs_cmd="update"
            else
              jobs_cmd="create"
            fi
            echo ": $jobs_cmd a job"

            gcloud beta run jobs $jobs_cmd migration --image="${{ env.IMAGE_HOST }}/${{ env.IMAGE_TAG_BASE }}:latest" --max-retries=1 --args="yarn,prisma,migrate,reset,-f" --service-account="$RUN_SERVICE_ACCOUNT" --vpc-connector="$VPC_CONNECTOR" --set-secrets="DATABASE_URL=DATABASE_URL:latest"
            gcloud beta run jobs execute migration --wait --format=json

  deploy:
    runs-on: ubuntu-latest

    needs:
      - migrate

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v1'
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v1'

      - name: CloudRun Deploy
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v0
        with:
          project_id: ${{ env.PROJECT_ID }}
          image: ${{ env.IMAGE_HOST }}/${{ env.IMAGE_TAG_BASE }}:latest
          region: ${{ env.GCP_REGION }}
          service: ${{ env.GCP_CLOUD_RUN_SERVICE_NAME }}
          flags: |
            --concurrency=200
            --max-instances=10
            --min-instances=1
            --cpu=1
            --memory=640Mi
          secrets:
            DATABASE_URL=DATABASE_URL:latest
```
:::

# ç§˜åŒ¿æƒ…å ±

ä¸Šè¨˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®šç¾©ã§ã¯ç§˜åŒ¿æƒ…å ±ã‚’ä»¥ä¸‹ã§ç®¡ç†ã—ã¦ã¾ã™ã€‚

- Github Actions ã® secrets

https://docs.github.com/ja/actions/security-guides/encrypted-secrets


- GCPã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼

https://cloud.google.com/secret-manager/docs/creating-and-accessing-secrets?hl=ja

# å®Ÿè¡Œ

ç§˜åŒ¿æƒ…å ±ã®æŒ‡å®šãŒã§ããŸã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚

ç„¡äº‹é€šã£ãŸğŸ‰

![](https://storage.googleapis.com/zenn-user-upload/82a4e74b32b2-20230124.png)

# å‹•ä½œç¢ºèª

ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã¡ã‚ƒã‚“ã¨å‹•ã„ã¦ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚CloudRun ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€DBã®å€¤ãŒå¸°ã£ã¦ããŸã‚‰OK

```bash
$ curl <CloudRunã®URL>/posts
[{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0e","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼‘","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"},{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0b","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼’","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"},{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0c","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼“","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"}]%
```

# å¾Œç‰‡ä»˜ã‘

æœ€å¾Œã« terraform destroy ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

```
$ terraform destroy
```

# ãŠã‚ã‚Šã«

ä»¥ä¸Šã€NestJS + Prisma ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ Github Actions ã§GCPç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã¾ã§ã®ã‚¤ãƒ³ãƒ•ãƒ©ã€CIã®æ§‹ç¯‰ã‚’ä¸€é€šã‚Šã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚ä¼¼ãŸã‚ˆã†ãªç’°å¢ƒã‚’ä½œã£ã¦ã¿ãŸã„ã¨æ€ã£ã¦ã‚‹äººã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

# å‚è€ƒ

https://zenn.dev/kou_pg_0131/articles/gh-actions-oidc-gcp

https://scrapbox.io/pokutuna/GCP_API_%E3%82%92_Terraform_%E3%81%8B%E3%82%89%E6%9C%89%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B

https://future-architect.github.io/articles/20210910a/

