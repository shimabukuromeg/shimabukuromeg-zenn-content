---
title: "NestJSã§GraphQLã¨Prismaã¨Passportã®ç´ æŒ¯ã‚Š"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nestjs", "graphql", "prisma", "passport"]
published: true
publication_name: "monicle"
---

# ã¯ã˜ã‚ã«

NestJSã§ã€GraphQLã€Prismaã€Passportã®ç´ æŒ¯ã‚Šã‚’ã—ãŸã¾ã¨ã‚è¨˜äº‹ã§ã™ã€‚

- NestJSã¨Prismaã®é€£æºã§DBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
- NestJSã§GraphQLã‚’åˆ©ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾—æ›´æ–°ã™ã‚‹
- NestJSã¨Passportã®é€£æºã—ã¦èªè¨¼ã€èªå¯ã®å‡¦ç†å®Ÿè£…ã™ã‚‹ï¼ˆCookie / Session ã«ã‚ˆã‚‹èªè¨¼ï¼‰

ã¯ã˜ã‚ã¦NestJSã‚’è§¦ã£ã¦ã¿ãŸã¨ãã«èªè¨¼ã‚„GraphQLãªã©ã‚’è©¦ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹äººã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚


https://github.com/shimabukuromeg/sample-nestjs

# è©¦ã—ã¦ã¿ã‚‹ã

ä»¥ä¸‹ã®é †ç•ªã§è©¦ã—ã¦ã„ãã¾ã™ã€‚

1. NestJSã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
2. Prisma
3. GraphQL
4. Passport

## 1. NestJSã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

ã¾ãšã¯NestJSã‹ã‚‰ã¯ã˜ã‚ã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ & èµ·å‹•ï¼ï¼ï¼

```bash
$ npm i -g @nestjs/cli
$ nest new sample-nestjs # ä»Šå›ã¯ yarn ã‚’é¸æŠã—ã¾ã—ãŸ
$ cd sample-nestjs
$ yarn run start
```

## 2. Prisma

ç¶šãã¾ã—ã¦ã€Prisma ã‚’ä½¿ã£ã¦DBã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã¿ã¾ã™ã€‚

ã¾ãšã¯å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™ã€‚

```bash
$ yarn add -D prisma typescript ts-node @types/node
```

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€åˆæœŸåŒ–ã—ã¾ã™ã€‚ã“ã®éš›ã€`prisma/schema.prisma` ã€`.env` ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™ã€‚

```bash
$ yarn prisma init
```

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§`postgres`ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ãŸã„ã®ã§ `docker-comose.yml` ã‚’ç”¨æ„ã—ã¾ã™ã€‚

:::details docker-compose.yml

`docker-compose.yml`

```yml
version: "3"

volumes:
  db-data:

services:
  db:
    image: postgres:14
    container_name: sample-nestjs
    volumes:
      - db-data:/var/lib/postgresql/sample-nestjs/data
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
```

:::

èµ·å‹•

```bash
$ docker compose up
```

ç«‹ã¡ä¸Šã’ãŸDBã«æ¥ç¶šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚`.env` ã®æ¥ç¶šæƒ…å ±ã‚’ä¿®æ­£ã—ã¾ã™ã€‚

:::details .env

`.env`

```
# Environment variables declared in this file are automatically made available to Prisma.
# See the documentation for more detail: https://pris.ly/d/prisma-schema#accessing-environment-variables-from-the-schema

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server, MongoDB and CockroachDB.
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

DATABASE_URL="postgresql://postgres:password@localhost:5432/sample-nestjs?schema=public"
```

:::

DBã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚`prisma/schema.prisma` ã‚’ç·¨é›†ã—ã¦`Post`ã‚¹ã‚­ãƒ¼ãƒã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

:::details prisma/schema.prisma

`prisma/schema.prisma`

```typescript
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Post {
  id        String   @id @default(uuid())
  title     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("posts")
}
```

:::

`prisma/schema.prisma` ã‚’ç·¨é›†ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚ã“ã®ã‚³ãƒãƒ³ãƒ‰ã¯ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ & å¤‰æ›´ã‚’DBã«åæ˜ ã—ã¦ãã‚Œã¾ã™ã€‚

```bash
$ yarn prisma migrate dev --name init
```

:::details å®Ÿè¡Œæ™‚ãƒ­ã‚°

```bash
$ yarn prisma migrate dev --name init
yarn run v1.22.19
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "sample-nestjs", schema "public" at "localhost:5432"

PostgreSQL database sample-nestjs created at localhost:5432

Applying migration `20221031030935_init`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20221031030935_init/
    â””â”€ migration.sql

Your database is now in sync with your schema.

Running generate... (Use --skip-generate to skip the generators)
[1/4] ğŸ”  Resolving packages...
[2/4] ğŸšš  Fetching packages...
[3/4] ğŸ”—  Linking dependencies...
warning " > ts-loader@9.4.1" has unmet peer dependency "webpack@^5.0.0".
[4/4] ğŸ”¨  Building fresh packages...
success Saved lockfile.
success Saved 2 new dependencies.
info Direct dependencies
â””â”€ @prisma/client@4.5.0
info All dependencies
â”œâ”€ @prisma/client@4.5.0
â””â”€ @prisma/engines-version@4.5.0-43.0362da9eebca54d94c8ef5edd3b2e90af99ba452

âœ” Generated Prisma Client (4.5.0 | library) to ./node_modules/@prisma/client in 104ms


âœ¨  Done in 13.84s.
```

:::

Prismaã«ã¯ä¾¿åˆ©ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚prisma studioã‚’å®Ÿè¡Œã—èµ·å‹•ã—ã¦ã¿ã¾ã™ã€‚

```bash
$ yarn prisma studio
```

ãƒ„ãƒ¼ãƒ«ãŒèµ·å‹•ã™ã‚‹ã®ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã§ãã¦ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ğŸ¥³

![](https://storage.googleapis.com/zenn-user-upload/a3772a45d8c5-20221031.png)

:::message

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±

https://www.prisma.io/docs/concepts/components/prisma-migrate

:::

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å‹æƒ…å ±ãªã©ã‚’è‡ªå‹•ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ã€‚ï¼ˆ`node_modules/.prisma/client/index.d.ts` ãŒæ›´æ–°ï¼‰

```bash
$ yarn prisma generate
```

ç¶šã„ã¦ã€seedã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã€ç™»éŒ²ã—ã¦ã¿ã¾ã™ã€‚seederã‚’æµã™ãŸã‚ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ `package.json` ã«è¿½è¨˜ã—ã€å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ`prisma/seed.ts` ã‚’ä½œæˆã—ã¾ã™ã€‚

```json
// è¿½è¨˜
"prisma": {
  "seed": "ts-node prisma/seed.ts"
}
```

:::details prisma/seed.ts

`prisma/seed.ts`

```typescript
import { Post, Prisma, PrismaClient } from "@prisma/client";
const prisma = new PrismaClient();

// ãƒ¢ãƒ‡ãƒ«æŠ•å…¥ç”¨ã®ãƒ‡ãƒ¼ã‚¿å®šç¾©
const postData: Post[] = [
  {
    id: "fa119cb6-9135-57f5-8a5a-54f28d566d0e",
    title: "ã‚¿ã‚¤ãƒˆãƒ«ï¼‘",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
  {
    id: "fa119cb6-9135-57f5-8a5a-54f28d566d0b",
    title: "ã‚¿ã‚¤ãƒˆãƒ«ï¼’",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
  {
    id: "fa119cb6-9135-57f5-8a5a-54f28d566d0c",
    title: "ã‚¿ã‚¤ãƒˆãƒ«ï¼“",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
];

const doPostSeed = async () => {
  const posts = [];
  for (const post of postData) {
    const createPosts = prisma.post.create({
      data: post,
    });
    posts.push(createPosts);
  }
  return await prisma.$transaction(posts);
};

const main = async () => {
  console.log(`Start seeding ...`);

  await doPostSeed();

  console.log(`Seeding finished.`);
};

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

:::

ç™»éŒ²ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ

```bash
$ yarn prisma db seed
```

ãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ãŸğŸ¥³

![](https://storage.googleapis.com/zenn-user-upload/114d2f9289d6-20221031.png)

:::message

seedã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

https://www.prisma.io/docs/guides/database/seed-database

:::

ç¶šã„ã¦ã€NestJSã‹ã‚‰Prismaã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å‘¼ã‚“ã§ã¿ã¾ã™ã€‚

èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚ã€NestJSã¯ã€Moduleå˜ä½ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ„ã¿ç«‹ã¦ã„ãã®ã‚’å¼·ããŠå‹§ã‚ã—ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚ã€Prismaç”¨ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ãŸã»ã†ãŒè‰¯ã•ãã†ã ãªã¨æ€ã£ãŸã‚Šã—ã¤ã¤ã‚‚ã€ä»Šå›ã¯ã„ã£ãŸã‚“ã‚µã‚¯ãƒƒã¨è©¦ã—ã¦ã¿ãŸã‹ã£ãŸã®ã§ã€Prismaã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã‚‹ãŠæ‰‹è»½ãã†ã ã£ãŸã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

https://www.prisma.io/nestjs#nestjs-tabs

:::message

moduleã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

https://docs.nestjs.com/modules

:::

`src/prisma.service.ts` ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
import { INestApplication, Injectable, OnModuleInit } from "@nestjs/common";
import { PrismaClient } from "@prisma/client";

@Injectable()
export class PrismaService extends PrismaClient implements OnModuleInit {
  async onModuleInit() {
    await this.$connect();
  }

  async enableShutdownHooks(app: INestApplication) {
    this.$on("beforeExit", async () => {
      await app.close();
    });
  }
}
```

`src/app.module.ts` ã®Providerã« `PrismaService` ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```typescript
import { Module } from "@nestjs/common";
import { AppController } from "./app.controller";
import { AppService } from "./app.service";
import { PrismaService } from "src/prisma.service";

@Module({
  controllers: [AppController],
  providers: [AppService, PrismaService],
})
export class AppModule {}
```

`src/app.service.ts` ã§`PrismaService`ã‚’ä½¿ã£ã¦`Post`ä¸€è¦§ã‚’å–å¾—ã—ã¾ã™ã€‚

```typescript
import { Injectable } from "@nestjs/common";
import { PrismaService } from "./prisma.service";

@Injectable()
export class AppService {
  constructor(private readonly prismaService: PrismaService) {}

  async getPosts() {
    // postä¸€è¦§å–å¾—
    return await this.prismaService.post.findMany();
  }
}
```

`src/app.controller.ts` ã§ã€`getPosts` ãŒå‘¼ã°ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

```typescript
import { Controller, Get } from "@nestjs/common";
import { AppService } from "./app.service";

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get("/posts")
  getPosts() {
    return this.appService.getPosts();
  }
}
```

curlã§ å‹•ä½œç¢ºèªã—ã¦ã¿ã‚‹ã¨ãƒ‡ãƒ¼ã‚¿è¿”ã£ã¦ãã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ğŸ¥³

```bash
$ curl http://localhost:3000/posts
[{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0e","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼‘","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"},{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0b","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼’","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"},{"id":"fa119cb6-9135-57f5-8a5a-54f28d566d0c","title":"ã‚¿ã‚¤ãƒˆãƒ«ï¼“","createdAt":"2022-01-30T19:34:22.000Z","updatedAt":"2022-01-30T19:34:22.000Z"}]%
```

## 3. GraphQL

ç¶šã„ã¦ã€GraphQLã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚GraphQLã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ã€ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã¨ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®ï¼’ã¤ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é–‹ç™ºæ–¹æ³•ãŒã‚ã‚Šã¾ã™ãŒã€ä»Šå›ã¯ã€ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã§å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥ã—ã¾ã™ã€‚

```bash
$ yarn add @nestjs/graphql @nestjs/apollo graphql apollo-server-express
```

GraphQLã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ `app.module.ts` ã®importsã«è¿½åŠ ã—ã¾ã™ã€‚

```typescript
import { Module } from "@nestjs/common";
import { AppController } from "./app.controller";
import { AppService } from "./app.service";
import { PrismaService } from "src/prisma.service";
import { ApolloDriver, ApolloDriverConfig } from "@nestjs/apollo";
import { GraphQLModule } from "@nestjs/graphql";
import * as path from "path";

@Module({
  controllers: [AppController],
  providers: [AppService, PrismaService],
  imports: [
    GraphQLModule.forRoot<ApolloDriverConfig>({
      driver: ApolloDriver,
      debug: false,
      // ã„ã£ãŸã‚“ã€playground ã¯æœ‰åŠ¹ã«ã—ã¦ãŠã
      playground: true,
      // è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã‚¹ã‚­ãƒ¼ãƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã™ã‚‹
      autoSchemaFile: path.join(process.cwd(), "src/schema.gql"),
    }),
  ],
})
export class AppModule {}
```

å®Ÿéš›ã«Queryã¨Mutationã‚’æ›¸ã„ã¦ã„ãã¾ã—ã‚‡ã†ã€‚Postã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã®ã§ã€ä¸‹è¨˜ã®Queryã¨Mutationã‚’ä½œã£ã¦ã¿ã¾ã™ã€‚

- Postä¸€è¦§ã®Query
- Postä½œæˆã®Mutation

Moduleã¨Resolverã®é››å½¢ã‚’ç”Ÿæˆã—ã¦ãã‚Œã‚‹ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ yarn nest g module posts
$ yarn nest g resolver posts
```

ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ã€ã„ãã¤ã‹æ–°ã—ãè¿½åŠ ã—ã¦Queryã¨Mutationã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã®è©³ç´°ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

:::details src/posts/posts.module.ts ã®ç·¨é›†

`src/posts/posts.module.ts`

```typescript
import { Module } from "@nestjs/common";
import { PostsResolver } from "./posts.resolver";
import { PrismaService } from "src/prisma.service";

@Module({
  providers: [PostsResolver, PrismaService],
})
export class PostsModule {}
```

:::

:::details src/posts/posts.resolver.ts ã®ç·¨é›†

`src/posts/posts.resolver.ts`

```typescript
import { Args, Mutation, Query, Resolver } from "@nestjs/graphql";
import { PostModel } from "./interfaces/post.model";
import { PrismaService } from "../prisma.service";
import { CreatePostInput } from "./interfaces/create-post.input";

@Resolver(() => PostModel)
export class PostsResolver {
  constructor(private readonly prismaService: PrismaService) {}

  @Query(() => [PostModel], { name: "posts", nullable: true })
  async getPosts() {
    return this.prismaService.post.findMany();
  }

  @Mutation(() => PostModel)
  async createPost(@Args("input") input: CreatePostInput) {
    return this.prismaService.post.create({
      data: {
        title: input.title,
      },
    });
  }
}
```

:::

:::details src/posts/interfaces/post.model.ts ã‚’ä½œæˆ
`src/posts/interfaces/post.model.ts`

```typescript
import { Field, ObjectType } from "@nestjs/graphql";

@ObjectType()
export class PostModel {
  @Field((type) => String)
  id: string;

  @Field((type) => String)
  title: string;
}
```

:::

:::details src/posts/interfaces/create-post.input.ts ã‚’ä½œæˆ
`src/posts/interfaces/create-post.input.ts` ã¯ `Post`æ–°è¦ä½œæˆã™ã‚‹éš›ã®inputã®å‹ã§ä½¿ã„ã¾ã™ã€‚

```typescript
import { Field, InputType } from "@nestjs/graphql";

@InputType()
export class CreatePostInput {
  @Field({ nullable: false })
  title: string;
}
```

:::

ä¸Šè¨˜ã®å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè£…å¾Œã€ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹•ï¼ˆã¾ãŸã¯é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­ï¼‰ã§ `src/schema.gql` ãŒè‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```graphql
# ------------------------------------------------------
# THIS FILE WAS AUTOMATICALLY GENERATED (DO NOT MODIFY)
# ------------------------------------------------------

type PostModel {
  id: String!
  title: String!
}

type Query {
  posts: [PostModel!]
}

type Mutation {
  createPost(input: CreatePostInput!): PostModel!
}

input CreatePostInput {
  title: String!
}
```

ä»¥ä¸Šã§å®Ÿè£…ã¯å®Œäº†ã§ã™ã€‚ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆ`http://localhost:3000/graphql`ï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Queryã€Mutationã‚’å©ã„ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

Queryã‚’å©ã„ã¦ã¿ã¾ã™ã€‚

```graphql
query {
  posts {
    id
    title
  }
}
```

![](https://storage.googleapis.com/zenn-user-upload/98395d66c64e-20221031.png)

å–å¾—ã§ããŸğŸ¥³

ç¶šã„ã¦ã€mutationã‚’å©ã„ã¦ã¿ã¾ã™ã€‚

```graphql
# Write your query or mutation here
mutation createPost($input: CreatePostInput!) {
  createPost(input: $input) {
    id
    title
  }
}

# {
#  "input": {
#    "title": "ã‚¿ã‚¤ãƒˆãƒ«100"
#  }
#}
```

ç™»éŒ²ã§ããŸ ğŸ¥³

![](https://storage.googleapis.com/zenn-user-upload/26b522f6e6c0-20221031.png)

## 4. Passport

Prismaã‚’ä½¿ã£ã¦ã®DBã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚ã€GraphQLä½¿ã£ã¦Queryã¨Mutationã‚’å©ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚

æœ€å¾Œã«Passportã¨NestJSã®guardã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦èªè¨¼ã¨èªå¯ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

:::message

èªè¨¼ã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

https://docs.nestjs.com/security/authentication

:::

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®èªè¨¼ã ã¨JWTã‚’æ¨ã—ã¦ãã†ãªæ„Ÿã˜ã§ã—ãŸãŒã€ä»Šå›ã¯Sessionã€Cookieã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã¿ã¾ã™ã€‚

å®Ÿè£…ã™ã‚‹ã«ã‚ãŸã£ã¦ã€ã“ã¡ã‚‰ã®è¨˜äº‹ãŒå¤§å¤‰å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚è¨˜äº‹å†…ã«ã‚‚æ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒã€å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½¿ç”¨æ–¹æ³•ã«é–¢ã—ã¦ä¸è¶³æ°—å‘³ãªã®ã§ã€ã¨ã¦ã‚‚å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚

https://dev.to/nestjs/setting-up-sessions-with-nestjs-passport-and-redis-210

### ä¸‹æº–å‚™ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã€Useræƒ…å ±ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰

èªè¨¼ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãå‰ã«ã€ä¸‹æº–å‚™ã¨ã—ã¦ã€Prismaã€NestJSã§ã€Useræƒ…å ±ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚„å®Ÿè£…ã‚’è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

`prisma/schema.prisma` ã«Userã®ã‚¹ã‚­ãƒ¼ãƒã‚’è¿½åŠ ã—ã¾ã™ã€‚

```typescript
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  isAdmin   Boolean  @default(false) @map("is_admin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}
```

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ yarn prisma migrate dev
```

:::details å®Ÿè¡Œæ™‚ã®ãƒ­ã‚°ã¨çµæœ

```bash
$ yarn prisma migrate dev
yarn run v1.22.19
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "sample-nestjs", schema "public" at "localhost:5432"

âœ” Enter a name for the new migration: â€¦ add users
Applying migration `20221031141038_add_users`

The following migration(s) have been created and applied from new schema changes:

migrations/
  â””â”€ 20221031141038_add_users/
    â””â”€ migration.sql

Your database is now in sync with your schema.

âœ” Generated Prisma Client (4.5.0 | library) to ./node_modules/@prisma/client in 73ms


âœ¨  Done in 11.01s.
```

prisma studioã§ç¢ºèªã—ãŸã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ãŸ

![](https://storage.googleapis.com/zenn-user-upload/4b0e032d9192-20221031.png)

:::

Useræƒ…å ±ã‚‚seedã§ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã¾ã™ã€‚

:::details prisma/seed.ts

`prisma/seed.ts`

```typescript
import { Post, Prisma, PrismaClient, User } from "@prisma/client";
const prisma = new PrismaClient();

// ãƒ¢ãƒ‡ãƒ«æŠ•å…¥ç”¨ã®ãƒ‡ãƒ¼ã‚¿å®šç¾©
const postData: Post[] = [
  {
    id: "fa119cb6-9135-57f5-8a5a-54f28d566d0e",
    title: "æ°—æŒã¡ã‚’è½ã¡ç€ã‹ã›ã‚‹å‘¼å¸æ³•",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
  {
    id: "545d5237-15ee-169c-13a2-30f8748e3d6e",
    title: "é«˜ã¶ã‚‹æ°—æŒã¡ã‚’å­˜åˆ†ã«ç™ºæ®ã—ãŸã„ã§ã™",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
  {
    id: "95daa18f-90d0-390c-fb96-0d152312936c",
    title: "ã‚†ã£ãã‚Šè½ã¡ç€ãæ°—æŒã¡ã‚’å¤§äº‹ã«ã—ãŸã„ã§ã™",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
];

const userData: User[] = [
  {
    id: "fa119cb6-9135-57f5-8a5a-54f28d566d0e",
    email: "admin@test.com",
    isAdmin: true,
    password: "$2b$12$s50omJrK/N3yCM6ynZYmNeen9WERDIVTncywePc75.Ul8.9PUk0LK",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
  {
    id: "fa119cb6-9135-57f5-8a5a-54f28d566d0f",
    email: "user01@test.com",
    isAdmin: false,
    password: "$2b$12$s50omJrK/N3yCM6ynZYmNeen9WERDIVTncywePc75.Ul8.9PUk0LK",
    createdAt: new Date("2022-01-31T04:34:22+09:00"),
    updatedAt: new Date("2022-01-31T04:34:22+09:00"),
  },
];

const doUserSeed = async () => {
  const users = [];
  for (const user of userData) {
    const createUsers = prisma.user.create({
      data: user,
    });
    users.push(createUsers);
  }
  return await prisma.$transaction(users);
};

const doPostSeed = async () => {
  const posts = [];
  for (const post of postData) {
    const createPosts = prisma.post.create({
      data: post,
    });
    posts.push(createPosts);
  }
  return await prisma.$transaction(posts);
};

const main = async () => {
  console.log(`Start seeding ...`);

  await doPostSeed();
  await doUserSeed();

  console.log(`Seeding finished.`);
};

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

:::

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦seedã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œç›´ã—ã¾ã™ã€‚

```bash
$ yarn prisma migrate reset
```

ç™»éŒ²ã§ãã¦ãŸ

![](https://storage.googleapis.com/zenn-user-upload/cf20791e171c-20221031.png)


`Post`ã®å ´åˆã¨åŒã˜è¦é ˜ã§ã€`User` ã®`Module`ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å©ã‘ã‚‹ã‚ˆã†ã«Resolverã‚’ç”¨æ„ã—ã¾ã™ã€‚

```bash
$ yarn nest g module users
$ yarn nest g resolver users
```

:::details src/users/interfaces/user.model.ts

`src/users/interfaces/user.model.ts`

```typescript
import { Field } from "@nestjs/graphql";
import { ObjectType } from "@nestjs/graphql";
import { ID } from "@nestjs/graphql";
import { HideField } from "@nestjs/graphql";

@ObjectType()
export class UserModel {
  @Field(() => ID, { nullable: false })
  id!: number;

  @Field(() => String, { nullable: false })
  email!: string;

  @HideField()
  password!: string;

  @HideField()
  createdAt!: Date;

  @HideField()
  updatedAt!: Date;
}
```

:::

:::details src/users/user.resolvers.ts `src/users/user.resolvers.ts`

```typescript
import { Query, Resolver } from "@nestjs/graphql";
import { UserModel } from "./interfaces/user.model";
import { PrismaService } from "../prisma.service";

@Resolver(() => UserModel)
export class UsersResolver {
  constructor(private readonly prismaService: PrismaService) {}

  @Query(() => [UserModel], { name: "users", nullable: true })
  async getUsers() {
    return this.prismaService.user.findMany({
      where: {
        isAdmin: false,
      },
    });
  }

  @Query(() => [UserModel], { name: "allUsers", nullable: true })
  async getAllUsers() {
    return this.prismaService.user.findMany();
  }
}
```
:::

:::details src/users/users.module.ts

`src/users/users.module.ts`

```typescript
import { Module } from "@nestjs/common";
import { PrismaService } from "src/prisma.service";
import { UsersResolver } from "./user.resolvers";

@Module({
  providers: [UsersResolver, PrismaService],
})
export class UsersModule {}
```

:::

QueryãŒå©ã‘ã‚‹ã“ã¨ã‚’ç¢ºèªã§ããŸã‚‰ä¸‹æº–å‚™çµ‚ã‚ã‚Šã§ã™ã€‚

```graphql
query ExampleAllUserQuery {
  allUsers {
    email
    id
  }
}
```

å©ã‘ãŸ
![](https://storage.googleapis.com/zenn-user-upload/1491ed150cc8-20221031.png)


### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å°å…¥

ä¸‹æº–å‚™ãŒã§ããŸã®ã§ã€èªè¨¼ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å°å…¥

```bash
$ yarn add @nestjs/passport passport passport-local express-session redis@^3 connect-redis bcrypt
$ yarn add -D @types/passport-local @types/express-session @types/connect-redis @types/bcrypt @types/redis
```

ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç”¨ã«Redisã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã—ãŸã„ã®ã§ `docker-compose.yml` ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã™ã€‚

:::details docker-compose.yml

`docker-compose.yml`

```yml
version: "3"

volumes:
  db-data:

services:
  db:
    image: postgres:14
    container_name: sample-nestjs
    volumes:
      - db-data:/var/lib/postgresql/sample-nestjs/data
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
  redis:
      image: redis:latest
      ports:
        - '6379:6379'
  rcli:
    image: redis:latest
    links:
      - redis
    command: redis-cli -h redis
```

:::

### ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

- express-sessionï¼ˆexpressã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ï¼‰
- connect-redisï¼ˆexpressã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®storeã«redisã‚’ã¤ã‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
- redisï¼ˆredisã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰

redisã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
$ yarn nest g module redis
```

:::details src/redis/redis.module.ts

`src/redis/redis.module.ts`

```typescript
import { Module } from "@nestjs/common";
import * as Redis from "redis";

import { REDIS } from "./redis.constants";

@Module({
  providers: [
    {
      provide: REDIS,
      useValue: Redis.createClient({ port: 6379, host: "localhost" }),
    },
  ],
  exports: [REDIS],
})
export class RedisModule {}
```

:::

:::details src/redis/redis.constants.ts

`src/redis/redis.constants.ts`

```typescript
export const REDIS = Symbol("AUTH:REDIS");
```

:::

:::details src/app.module.ts

`src/app.module.ts`

```typescript
import {
  Inject,
  Logger,
  MiddlewareConsumer,
  Module,
  NestModule,
} from "@nestjs/common";
import * as RedisStore from "connect-redis";
import * as session from "express-session";
import * as passport from "passport";
import { RedisClient } from "redis";
import { AppController } from "./app.controller";
import { AppService } from "./app.service";
import { GraphQLModule } from "@nestjs/graphql";
import { ApolloDriver, ApolloDriverConfig } from "@nestjs/apollo";
import { PostsModule } from "./posts/posts.module";
import { UsersModule } from "./users/users.module";
import * as path from "path";
import { RedisModule } from "./redis/redis.module";
import { REDIS } from "./redis/redis.constants";
import { PrismaService } from "./prisma.service";

@Module({
  controllers: [AppController],
  providers: [AppService, Logger, PrismaService],
  imports: [
    GraphQLModule.forRoot<ApolloDriverConfig>({
      driver: ApolloDriver,
      debug: false,
      playground: true,
      autoSchemaFile: path.join(process.cwd(), "src/schema.gql"),
      sortSchema: true,
      // GraphQLã®éƒ¨åˆ†ã§corsã®è¨­å®šãªã©ã‚‚åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ã‚‹
      cors: {
        origin: ["http://localhost:3000"],
        credentials: true,
        allowedHeaders: "Origin, X-Requested-With, Content-Type, Accept",
        methods: "*",
      },
    }),
    PostsModule,
    UsersModule,
    RedisModule,
  ],
})
export class AppModule implements NestModule {
  constructor(@Inject(REDIS) private readonly redis: RedisClient) {}
  configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(
        session({
          store: new (RedisStore(session))({
            client: this.redis,
            logErrors: true,
          }),
          saveUninitialized: false,
          secret: "secret",
          resave: false,
          cookie: {
            sameSite: "lax",
            httpOnly: false,
            maxAge: 60000,
            secure: false,
            domain: "localhost",
          },
        }),
        passport.initialize(),
        passport.session(),
      )
      .forRoutes("*");
  }
}
```

:::

### èªè¨¼ã€èªå¯ã®å®Ÿè£…

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®é››å½¢ã‚’ç”Ÿæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```typescript
$ yarn nest g module auth
$ yarn nest g resolver auth
```

Userã®å‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã§ä½¿ã†Inputã®å‹ã‚’å®šç¾©ã—ã¾ã™ã€‚

:::details `src/modules/auth/models/user.interface.ts`

`src/modules/auth/models/user.interface.ts`
```typescript
export interface User {
    id: string;
    email: string;
    password: string;
    isAdmin: boolean;
}
```
:::

:::details `src/modules/auth/models/register-user.input.ts`

`src/modules/auth/models/register-user.input.ts`

```typescript
import { Field, InputType } from '@nestjs/graphql';

@InputType()
export class RegisterUserInput {
    @Field({ nullable: false })
    email: string;

    @Field({ nullable: false })
    password: string;

    @Field({ nullable: false })
    confirmationPassword: string;
}
```
:::

:::details `src/modules/auth/models/login-user.input.ts`
`src/modules/auth/models/login-user.input.ts`
```typescript
import { Field, InputType } from '@nestjs/graphql';

@InputType()
export class LoginUserInput {
    @Field({ nullable: false })
    email: string;

    @Field({ nullable: false })
    password: string;
}
```
:::

LocalStrategy ã‚’å®Ÿè£…ã—ã¾ã™ã€‚`@nestjs/passport` ã¯`passport` ã®è–„ã„ãƒ©ãƒƒãƒ‘ãƒ¼ã§ã€passportã®validateã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«æ¸¡ã™é–¢æ•°ã®å®šç¾©ãªã©

:::details `src/modules/auth/local.strategy.ts`
`src/modules/auth/local.strategy.ts`
```typescript
import { Injectable } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy } from 'passport-local';
import { AuthService } from './auth.service';

@Injectable()
export class LocalStrategy extends PassportStrategy(Strategy) {
    constructor(private readonly authService: AuthService) {
        console.log("== call LocalStrategy constructor ==");
        super({
            usernameField: 'email',
        });
    }

    async validate(email: string, password: string) {
        console.log("== call LocalStrategy validate ==");

        const user = await this.authService.validateUser({ email, password });
        return user
    }
}

```
:::

ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®å®Ÿè£…ã€‚`serializeUser` ã®å‡¦ç†ã‚’é€šã£ãŸå¾Œã‹ã‚‰ `req.session.passport.user` ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã‚‹

:::details `src/modules/auth/serialization.provider.ts`
`src/modules/auth/serialization.provider.ts`

```typescript
import { Injectable } from '@nestjs/common';
import { PassportSerializer } from '@nestjs/passport';

import { AuthService } from './auth.service';
import { User } from './models/user.interface';

@Injectable()
export class AuthSerializer extends PassportSerializer {
    constructor(private readonly authService: AuthService) {
        super();
    }
    serializeUser(user: User, done: (err: Error, user: { id: string; isAdmin: boolean }) => void) {
        console.log("== call serializeUser ==");

        done(null, { id: user.id, isAdmin: user.isAdmin });
    }

    async deserializeUser(payload: { id: string; isAdmin: boolean }, done: (err: Error, user: Omit<User, 'password'>) => void) {
        console.log("== call deserializeUser ==");

        const user = await this.authService.findById(payload.id);
        done(null, user);
    }
}

```
:::

ç¶šã„ã¦ã‚¬ãƒ¼ãƒ‰ã®å®Ÿè£…ã€‚ã‚¬ãƒ¼ãƒ‰ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ã‚„ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«å¿œã˜ã¦ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦èªå¯ã®å‡¦ç†ã‚’è¡Œãˆã¾ã™ã€‚ï¼ˆæ¨©é™ãŒãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦403ã‚’è¿”ã™ãªã©ï¼‰

:::message
ã‚¬ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãƒšãƒ¼ã‚¸

https://docs.nestjs.com/guards
:::


:::details `src/guard/local.guard.ts`

`src/guard/local.guard.ts`

ãƒ­ã‚°ã‚¤ãƒ³ã®Mutationå®Ÿè¡Œã™ã‚‹æ™‚ã«å‘¼ã³å‡ºã™ã‚„ã¤

```typescript
import { ExecutionContext, Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';
import { GqlExecutionContext } from '@nestjs/graphql';

@Injectable()
export class LocalGuard extends AuthGuard('local') {
    async canActivate(context: ExecutionContext): Promise<boolean> {
        console.log("== call LocalGuard canActivate ==");

        const ctx = GqlExecutionContext.create(context);
        const gqlReq = ctx.getContext().req;
        const result = (await super.canActivate(context)) as boolean;

        console.log("== call canActivate gqlReq before ==", gqlReq.session)

        // logIn ã‚’å®Ÿè¡Œã™ã‚‹
        // ğŸ‘‡
        // ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®å‡¦ç†ãŒå‘¼ã°ã‚Œã‚‹
        // ğŸ‘‡
        // useræƒ…å ±ä»˜ä¸ã•ã‚Œã‚‹
        // ä¾‹.
        // Session {
        //    ..
        //    passport: { user: { id: 'aaa', isAdmin: false } }
        // }
        await super.logIn(gqlReq);

        console.log("== call canActivate gqlReq after ==", gqlReq.session)

        return result;
    }

    getRequest(context: ExecutionContext) {
        console.log("== call LocalGuard getRequest ==");

        const ctx = GqlExecutionContext.create(context);
        const gqlReq = ctx.getContext().req;

        if (gqlReq) {
            const { input } = ctx.getArgs();
            gqlReq.body = input;

            return gqlReq;
        }
        return context.switchToHttp().getRequest();
    }
}
```
:::

:::details `src/guard/logged-in.guard.ts`

`src/guard/logged-in.guard.ts`

ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚¬ãƒ¼ãƒ‰

```typescript
import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';
import { GqlExecutionContext } from '@nestjs/graphql';


@Injectable()
export class LoggedInGuard implements CanActivate {
    canActivate(context: ExecutionContext) {
        console.log("== call LoggedInGuard canActivate ==");

        const ctx = GqlExecutionContext.create(context);
        const gqlReq = ctx.getContext().req;

        if (gqlReq) {
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã‹ã£ãŸã‚‰falseã«ãªã£ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚
            return gqlReq.isAuthenticated();
        }

        return context.switchToHttp().getRequest().isAuthenticated();
    }
}
```
:::

:::details `src/guard/admin.guard.ts`

`src/guard/admin.guard.ts`

ã‚¢ãƒ‰ãƒŸãƒ³ãƒ­ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã‚¬ãƒ¼ãƒ‰


```typescript
import { ExecutionContext, Injectable } from '@nestjs/common';
import { GqlExecutionContext } from '@nestjs/graphql';

import { LoggedInGuard } from './logged-in.guard';

@Injectable()
export class AdminGuard extends LoggedInGuard {
    canActivate(context: ExecutionContext): boolean {
        console.log("== call AdminGuard canActivate ==");

        const ctx = GqlExecutionContext.create(context);
        const gqlReq = ctx.getContext().req;

        if (gqlReq) {
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ã¤ã‚¢ãƒ‰ãƒŸãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã˜ã‚ƒãªã„ã¨ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚
            return gqlReq.isAuthenticated() && gqlReq.session.passport.user.isAdmin;
        }

        const req = context.switchToHttp().getRequest();
        return super.canActivate(context) && req.session.passport.user.isAdmin;
    }
}
```
:::

èªè¨¼ã€èªå¯ã«å¿…è¦ãªå®Ÿè£…ãŒã§ããŸã®ã§ã€æœ€å¾Œã«Authãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ãƒªã‚¾ãƒ«ãƒãƒ¼ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

:::details `src/modules/auth/auth.module.ts`

`src/modules/auth/auth.module.ts`

```typescript
import { Module } from '@nestjs/common';
import { PassportModule } from '@nestjs/passport';
import { PrismaService } from 'src/prisma.service';
import { AuthResolver } from './auth.resolver';

import { AuthService } from './auth.service';
import { LocalStrategy } from './local.strategy';
import { AuthSerializer } from './serialization.provider';

@Module({
    imports: [
        PassportModule.register({
            session: true,
        }),
    ],
    providers: [AuthResolver, AuthService, LocalStrategy, AuthSerializer, PrismaService],
})
export class AuthModule { }
```
:::

:::details `src/modules/auth/auth.resolver.ts`
`src/modules/auth/auth.resolver.ts`
```typescript
import { UseGuards } from '@nestjs/common';
import { Resolver, Mutation, Args, Context } from '@nestjs/graphql';
import { AuthService } from './auth.service';
import { LocalGuard } from '../../guard/local.guard';
import { LoginUserInput } from './models/login-user.input';
import { RegisterUserInput } from './models/register-user.input';
import { UserModel } from '../users/interfaces/user.model';

@Resolver()
export class AuthResolver {
    constructor(private readonly authService: AuthService) { }

    @UseGuards(LocalGuard)
    @Mutation(() => UserModel, { nullable: true })
    async login(
        @Args('input') input: LoginUserInput,
        @Context() context
    ) {
        console.log("== call AuthResolver login mutation ==");

        return context.req.user
    }

    @Mutation(() => UserModel, { nullable: true })
    async register(
        @Args('input') input: RegisterUserInput,
        @Context() context
    ) {
        console.log("== call AuthResolver login mutation ==");

        return this.authService.registerUser(input)
    }
}
```
:::

:::details `src/modules/auth/auth.service.ts`
`src/modules/auth/auth.service.ts`
```typescript
import { BadRequestException, Injectable, UnauthorizedException } from '@nestjs/common';
import { compare, hash } from 'bcrypt';

import { LoginUserInput } from './models/login-user.input';
import { RegisterUserInput } from './models/register-user.input';
import { User } from './models/user.interface';
import { PrismaService } from '../../prisma.service'

@Injectable()
export class AuthService {
    constructor(private readonly prismaService: PrismaService) { }

    async validateUser(user: LoginUserInput) {
        const foundUser = await this.prismaService.user.findUnique({
            where: {
                email: user.email
            }
        });

        if (!user || !(await compare(user.password, foundUser.password))) {
            throw new UnauthorizedException('Incorrect username or password');
        }
        const { password: _password, ...retUser } = foundUser;
        return retUser;
    }

    async registerUser(user: RegisterUserInput): Promise<Omit<User, 'password'>> {
        const existingUser = await this.prismaService.user.findUnique({
            where: {
                email: user.email
            }
        });
        if (existingUser) {
            throw new BadRequestException('User remail must be unique');
        }
        if (user.password !== user.confirmationPassword) {
            throw new BadRequestException('Password and Confirmation Password must match');
        }
        const { confirmationPassword: _, ...newUser } = user;

        const u = await this.prismaService.user.create({
            data: {
                email: newUser.email,
                password: await hash(newUser.password, 12),
                isAdmin: false
            }
        })

        return {
            id: u.id,
            email: u.email,
            isAdmin: u.isAdmin,
        };
    }

    async findById(id: string): Promise<Omit<User, 'password'>> {
        const user = await this.prismaService.user.findUnique({
            where: {
                id: id
            }
        })

        if (!user) {
            throw new BadRequestException(`No user found with id ${id}`);
        }
        return {
            id: user.id,
            email: user.email,
            isAdmin: user.isAdmin
        };
    }
}

```
:::

ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ã™ã‚‹Queryã«èªå¯ã®å‡¦ç†ã‚’å…¥ã‚Œã¦ã¿ã‚‹

:::details src/users/user.resolvers.ts `src/users/user.resolvers.ts`

```typescript
import { Query, Resolver } from '@nestjs/graphql';
import { UserModel } from './interfaces/user.model';
import { PrismaService } from '../../prisma.service'
import { LoggedInGuard } from '../../guard/logged-in.guard';
import { AdminGuard } from '../../guard/admin.guard';
import { UseGuards } from '@nestjs/common';

@Resolver(() => UserModel)
export class UsersResolver {
    constructor(private readonly prismaService: PrismaService) { }

    // NOTE:ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹
    @UseGuards(LoggedInGuard)
    @Query(() => [UserModel], { name: 'users', nullable: true })
    async getUsers() {
        return this.prismaService.user.findMany({
            where: {
                isAdmin: false
            }
        });
    }

    // NOTE: Adminãƒ­ãƒ¼ãƒ«ã‚’æŒã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒå®Ÿè¡Œã§ãã‚‹
    @UseGuards(AdminGuard)
    @Query(() => [UserModel], { name: 'allUsers', nullable: true })
    async getAllUsers() {
        return this.prismaService.user.findMany();
    }
}
```

:::

ä»¥ä¸Šã§å®Ÿè£…ã¯çµ‚ã‚ã‚Šã§ã™ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ã‹ã©ã†ã‹ã«å¿œã˜ã¦ã€QueryãŒå©ã‘ã‚‹ã‹ã©ã†ã‹ã®å‹•ä½œç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãªã„çŠ¶æ…‹ã§Queryå©ã„ã¦ã¿ã‚‹

```graphql
query ExampleUserQuery {
  users {
    email
    id
  }
}
```

Queryå©ã„ãŸçµæœãƒ‡ãƒ¼ã‚¿å–å¾—ã§ããšï¼ï¼ˆæƒ³å®šé€šã‚ŠğŸ¥³ï¼‰

![](https://storage.googleapis.com/zenn-user-upload/1ccbfc31b9fc-20221105.png)

ãƒ­ã‚°ã‚¤ãƒ³ã®mutationã‚’å©ã„ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹

```graphql
# Write your query or mutation here
mutation Login($input: LoginUserInput!) {
  login(input: $input) {
    email
    id
  }
}

# {
#   "input": {
#     "email": "user01@test.com",
#     "password": "Passw0rd!"
#   }
# }
```

ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼Cookieã‚‚è¿½åŠ ã•ã‚Œã¦ãŸğŸ¥³

![](https://storage.googleapis.com/zenn-user-upload/b9a734c8ec9d-20221105.png)

ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§Queryå©ã„ã¦ã¿ã‚‹

```graphql
query ExampleUserQuery {
  users {
    email
    id
  }
}
```

å–å¾—ã§ããŸğŸ¥³

![](https://storage.googleapis.com/zenn-user-upload/4497cc803912-20221105.png)


# ãŠã‚ã‚Šã«

- NestJSã§GraphQLã¨Prismaã¨èªè¨¼èªå¯ã®ä»•çµ„ã¿ãŒã‚ã‹ã£ã¦ã‚ˆã‹ã£ãŸã€‚æ¦‚è¦ã¨é›°å›²æ°—ãŒã‚ã‹ã£ãŸã€‚ç´°ã‹ã„ã¨ã“ã‚ã¯ã‚‚ã†å°‘ã—ã¡ã‚ƒã‚“ã¨ã¿ã‚‹
- èªè¨¼ã«é–¢ã—ã¦ã¯ã€NestJSä»¥å‰ã«ã€passportã®ä»•çµ„ã¿ãŒã‚ã‹ã£ã¦ãªã‹ã£ãŸã‘ã©ã€ã©ã‚“ãªæ„Ÿã˜ã§å‹•ã„ã¦ã‚‹ã‹ã‚ã‹ã£ã¦ã‚ˆã‹ã£ãŸã€‚[ã“ã®è¨˜äº‹](https://dev.to/nestjs/setting-up-sessions-with-nestjs-passport-and-redis-210)ãŒpassportã¨ã‹ã®è§£èª¬ã¾ã§ã—ã¦ã¦ã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸã€‚
- æ¬¡ã¯ã€ç’°å¢ƒã”ã¨ã®ç’°å¢ƒå¤‰æ•°ã®åˆ‡ã‚Šæ›¿ãˆã€ãƒ‡ãƒ—ãƒ­ã‚¤å‘¨ã‚Šã€ãªã©è©¦ã—ã¦ã¿ã‚‹ãã€‚


# å‚è€ƒ

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚ˆã†ã‚„ã & æ—¥æœ¬èªã§ã‚ã‹ã‚Šã‚„ã™ã„ã„ã„ã¾ã¨ã‚

https://zenn.dev/morinokami/articles/nestjs-overview

nestjsã‚’ä¸€é€šã‚Šå‹•ã‹ã—ã¦ã¿ã‚‹éš›ã«ã„ã„æœ¬

https://zenn.dev/waddy/books/graphql-nestjs-nextjs-bootcamp/viewer/nestjs

redisæœ€æ–°ã ã¨æ€’ã‚‰ã‚Œã®ã§ã„ã£ãŸã‚“v3ã§å‹•ã‹ã—ã¦ã‚‹

https://github.com/redis/node-redis/blob/master/docs/v3-to-v4.md

ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚ã‹ã£ã¦ãªã‹ã£ãŸã‹ã‚‰ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚„ã£ãŸ

https://www.passportjs.org/tutorials/password/
