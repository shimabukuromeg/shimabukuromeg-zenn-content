---
title: "Supabaseã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§GraphQLã‚’å‹•ã‹ã—ã¦ã¿ã‚‹ã"
emoji: "ğŸ‘‹"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["supabase"]
published: true
---

# ã¯ã˜ã‚ã«

Supabaseã‚’ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§æ§‹ç¯‰ã—ã€GraphqQLã®ã‚¯ã‚¨ãƒªã‚’å©ã„ã¦ã¿ã‚‹ã¨ã“ã‚ã¾ã§ã‚„ã£ã¦ã¿ãŸè¨˜äº‹ã§ã™ã€‚
Supabaseã¯ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒæ§‹ç¯‰ã®ãŸã‚ã®CLIãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€ã‚³ãƒãƒ³ãƒ‰ã‚’ä½•å›ã‹å©ãã ã‘ã§ç’°å¢ƒã‚’ç”¨æ„ã§ãã¾ã™ã€‚docker-composeã®è¨­å®šãªã©ã‚‚å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚
GraphQLã®ã‚µãƒãƒ¼ãƒˆã¯PostgreSQLã®æ‹¡å¼µæ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã—ã¦ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†æ§‹ç¯‰ã™ã‚‹ã ã‘ã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
åŸºæœ¬çš„ã« ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Local Development ã®ç« ã‚’ãªãã£ã¦ã„ã‚‹ã ã‘ã§ã™ãŒã€Supabaseã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å‹•ã‹ã—ãŸã„ã€æ‰‹å…ƒã«GraphQLãŒå‹•ã‹ã›ã‚‹ç’°å¢ƒã‚’ç”¨æ„ã—ãŸã„äººã®å‚è€ƒã«ãªã‚Œã°å¬‰ã—ã„ã§ã™ã€‚

https://supabase.com/docs/guides/local-development

- GraphQL ãŒ Supabase ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ

https://supabase.com/blog/graphql-now-available

# ç’°å¢ƒæ§‹ç¯‰

- Supabase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
$ brew install supabase/tap/supabase
```

https://github.com/supabase/cli


- ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
$ mkdir my-supabase-project
$ cd my-supabase-project
$ git init

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
$ supabase init

# èµ·å‹•
$ supabase start
```

:::details `supabase start` å®Ÿè¡Œçµæœ

- `supabase start` å®Ÿè¡Œå¾Œã€API URLã‚„keyã®æƒ…å ±ãªã©ã‚’å–å¾—ã§ãã‚‹

```bash
$ supabase start
Started supabase local development setup.

         API URL: http://localhost:54321
          DB URL: postgresql://postgres:postgres@localhost:54322/postgres
      Studio URL: http://localhost:54323
    Inbucket URL: http://localhost:54324
        anon key: <your anon key>
service_role key: <your service_role key>
```
:::

- èµ·å‹•å¾Œã€http://localhost:54323 ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Studioã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚æœ¬ç•ªç’°å¢ƒã¨åŒæ§˜ã®GUIæ“ä½œã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§ã§ãã‚‹ã®ã¯ä¾¿åˆ©ã€‚


![](https://storage.googleapis.com/zenn-user-upload/21f73e795450-20220814.png)

# ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ‡ãƒ¼ã‚¿è¿½åŠ 

å‹•ã‹ã—ã¦ã¿ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã€‚Studioã®ç”»é¢ã‹ã‚‰GUIã®æ“ä½œã§è¿½åŠ ã—ã¾ã™ã€‚


:::details ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹


![](https://storage.googleapis.com/zenn-user-upload/b50fb1f343b0-20220814.png)

:::


:::details SQLã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”¨ã® `employees` ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç”¨ã®SQLã‚’å®Ÿè¡Œã™ã‚‹

- SQLã‚¨ãƒ‡ã‚£ã‚¿ã®ç”»é¢ã«ä»¥ä¸‹ã®SQLã‚’å…¥åŠ›ã—ã¦å®Ÿè¡Œã™ã‚‹

```sql
create table employees (
    id integer primary key generated always as identity,
    name text
);
```

![](https://storage.googleapis.com/zenn-user-upload/6a0ad040287b-20220814.png)

:::



:::details ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ `employees` ãŒä½œæˆã•ã‚Œã¦ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã‚‹

- `employees` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/08fef91ddbec-20220814.png)

:::

- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ãŸã‚‰ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ã€‚ï¼ˆ`supabase/migrations/<timestamp>_create_employees.sql` ãŒç”Ÿæˆã•ã‚Œã‚‹ï¼‰

```bash
$ supabase db commit create_employees
```

- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿è¿½åŠ ã™ã‚‹ãŸã‚ã«ã‚·ãƒ¼ãƒ€ãƒ¼ã‚’ä½œæˆã™ã‚‹ã€‚`supabase/seed.sql` ã‚’æ–°ã—ãä½œã£ã¦ä»¥ä¸‹ã®SQLã‚’è¿½åŠ ã™ã‚‹ã€‚

```
insert into public.employees (name)
values 
  ('Erlich Backman'),
  ('Richard Hendricks'),
  ('Monica Hall');
```

- ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚·ãƒ¼ãƒ€ãƒ¼ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œã•ã›ã¦ã€ã‚·ãƒ¼ãƒ€ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã•ã›ã‚‹

```bash
$ supabase db reset
```

:::details å®Ÿè¡Œçµæœ

- ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒè¿½åŠ ã•ã‚Œã¦ã‚‹ã“ã¨

![](https://storage.googleapis.com/zenn-user-upload/326eb5a25d68-20220814.png)

:::

:::message
ãƒ­ãƒ¼ã‚«ãƒ«ã®DBã®migrationã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ãŸã„å ´åˆã€`$ supabase db reset` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãƒªã‚»ãƒƒãƒˆã§ãã¾ã™ã€‚ãã®éš›ã€`supabase/seed.sql` ã®åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚‚å†åº¦æµã•ã‚Œç›´ã—ã¾ã™ã€‚
:::

# GraphQLã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã„ã¦ã¿ã‚‹

ãƒ†ã‚¹ãƒˆç”¨ã«ä½œã£ãŸ `employees` ã®ãƒ‡ãƒ¼ã‚¿ã‚’GraphQLã®ã‚¯ã‚¨ãƒªã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã™ã€‚

- `employees` ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¦ SQL schemaã‚’å¤‰æ›´ã—ãŸã®ã§ã€SQLã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œã—ã¦ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†æ§‹ç¯‰ã™ã‚‹

    ```sql
    select graphql.rebuild_schema();
    ```

https://supabase.com/docs/guides/api#graphql-api


- Apollo Studioã® sandbox ã‹ã‚‰Queryã‚’ã‚’å©ã„ã¦ã¿ã‚‹

https://studio.apollographql.com/sandbox/explorer


:::details sandbox ã‹ã‚‰Queryã‚’ã‚’å©ã„ã¦ã¿ã‚‹ãŸã‚ã®è¨­å®š

- ãƒ­ãƒ¼ã‚«ãƒ«ã®supabaseã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã€sandboxã«è¨­å®šã‚’è¿½åŠ ã™ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/097bf8e71c8d-20220814.png)

- å¿…è¦ãªé …ç›®ï¼ˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã‚­ãƒ¼ï¼‰ã‚’å…¥åŠ›ã—ã¦ä¿å­˜ã™ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/d1d169db3b0b-20220814.png)

- supabaseã®API URLã¨anon keyã‚­ãƒ¼ã‚’ç¢ºèªã—ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹

```bash
$ supabase status
supabase local development setup is running.

         API URL: http://localhost:54321
          DB URL: postgresql://postgres:postgres@localhost:54322/postgres
      Studio URL: http://localhost:54323
    Inbucket URL: http://localhost:54324
        anon key: <your anon key>
service_role key: <your service_role key>
```

- ã‚­ãƒ¼ã«ã¤ã„ã¦ã€‚æ¬¡ã® 2 ã¤ã®ã‚­ãƒ¼ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹
    - anon key ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å®‰å…¨ã«ä½¿ç”¨ã§ãã‚‹ã‚­ãƒ¼ã€‚
    - service_role key ã‚µãƒ¼ãƒãƒ¼ã§ã®ã¿ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚­ãƒ¼ã€‚ã“ã®ã‚­ãƒ¼ã¯è¡Œãƒ¬ãƒ™ãƒ« ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§ã“ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
    - https://supabase.com/docs/guides/api#api-keys

:::

- ä»¥ä¸‹ã®Queryã‚’å©ã„ã¦ã¿ã‚‹

```gql
query Query {
  employeesCollection {
    edges {
      node {
        id
        name
      }
    }   
  }
}
```


- å–å¾—ã§ããŸï¼ï¼ï¼

![](https://storage.googleapis.com/zenn-user-upload/89e8c429e409-20220814.png)

- ã¤ã„ã§ã«Mutationã‚‚å©ã„ã¦ã¿ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/4a242915d0e6-20220814.png)

```
# Operation
mutation Mutation($objects: [employeesInsertInput!]!) {
  insertIntoemployeesCollection(objects: $objects) {
    records {
      id
      name
    }
  }
}

# Variables
{
  "objects": [
    {
      "name": "å¤ªéƒ"
    }
  ]
}
```

- è¿½åŠ ã§ããŸï¼ï¼ï¼

![](https://storage.googleapis.com/zenn-user-upload/88adbb3aa88c-20220814.png)

# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ãƒªãƒ¢ãƒ¼ãƒˆç’°å¢ƒã«åæ˜ ã•ã›ã‚‹

- DBã®å¤‰æ›´ãªã©ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§å¤‰æ›´sãŸã„å†…å®¹ã‚’[app.supabase.com](https://app.supabase.com/)ä¸Šã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ ã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
# ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã¨ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç´ä»˜ã‘ã‚‹
$ supabase link --project-ref <your-project-ref>

# ãƒªãƒ¢ãƒ¼ãƒˆã®DBã‚’ã‚»ãƒƒãƒˆã™ã‚‹
$ supabase db remote set 'postgresql://postgres:<your_password>@db.<your_project_ref>.supabase.co:5432/postgres'

# Studioã§GUIã®æ“ä½œã‹ã‚‰SQLã‚’å®Ÿè¡Œã—ã¦ã‚¹ã‚­ãƒ¼ãƒã«å¤‰æ›´ã‹ã‘ãŸå¾Œã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹
$ supabase db commit create_hoges

# ãƒ­ãƒ¼ã‚«ãƒ«ã®DBã®å¤‰æ›´ã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«åæ˜ ã•ã›ã‚‹
$ supabase db push
```

:::details è©¦ã—ã¦ã¿ãŸ

- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§é©å½“ãªãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œã£ã¦ã¿ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/5197eee7657d-20220814.png)

```sql
create table foods (
    id integer primary key generated always as identity,
    name text,
    value text
);
```

- ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹

```
$ supabase db commit create_foods
Finished supabase db commit on branch main.
WARNING: The diff tool is not foolproof, so you may need to manually rearrange and modify the generated migration.
Run supabase db reset to verify that the new migration does not generate errors.
```

- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚ŒãŸ

![](https://storage.googleapis.com/zenn-user-upload/833a79408285-20220814.png)


- ãƒªãƒ¢ãƒ¼ãƒˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åæ˜ ã•ã›ã‚‹

```bash
$ supabase db push
Applying unapplied migrations...
Finished supabase db push.
```

- ãƒªãƒ¢ãƒ¼ãƒˆç’°å¢ƒã«ã‚‚ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ãŒåæ˜ ã•ã‚ŒãŸ

![](https://storage.googleapis.com/zenn-user-upload/87a988fbfa3c-20220814.png)

:::



# ãŠã‚ã‚Šã«

- ä»¥å‰ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§Supabaseã‚’å‹•ã‹ã—ãŸæ™‚ã¯ã€CLIã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ä½œã‚‹æ©Ÿèƒ½ãŒã¾ã ãªã‹ã£ãŸã®ã§ã€docker-composeã®è¨­å®šã‚’è‰²ã€…ã¨è©¦ã—ãªãŒã‚‰å‹•ã‹ã—ã¦ã„ãŸã®ã§ã™ãŒã€ä»Šå›è©¦ã—ã¦ã¿ã¦ã€ã‚³ãƒãƒ³ãƒ‰æ•°å›å©ãã ã‘ã§ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒãŒä½œã‚Œã‚‹ã®ã¯æ„Ÿå‹•ã—ã¾ã—ãŸã€‚
- GraphQLã‚’ä½¿ã†éš›ã«ã€ã‚¹ã‚­ãƒ¼ãƒã‚’å†æ§‹ç¯‰ã™ã‚‹SQLã‚’å©ã‹ãªã„ã¨GraphQLä½¿ãˆãªã„ã“ã¨ã«æ°—ãŒã¤ã‹ãšå°‘ã—ãƒãƒã‚Šã¾ã—ãŸãŒã€ã»ã¨ã‚“ã©ä½•ã‚‚ã—ãªãã¦ã‚‚GraphQLã®æ©Ÿèƒ½ãŒä½¿ãˆã¦ä¾¿åˆ©ã§è‰¯ã‹ã£ãŸã€‚
- æœ¬ç­‹ã¨é–¢ä¿‚ãªã„ã§ã™ãŒã€apollo studio è£œå®ŒãŒã‚ã£ã¡ã‚ƒåŠ¹ã„ã¦ã€ã‚¯ã‚¨ãƒªæãã‚„ã™ãã¦ã‹ãªã‚Šä¾¿åˆ©ã§ã—ãŸã€‚
- ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã‚’ç”Ÿã®SQLã§ç®¡ç†ã™ã‚‹ã®å¤§å¤‰ãã†ãªã®ã§ã€Prismaã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ã£ãŸæ–¹ãŒè‰¯ã•ãã†ã‹ãªã¨æ€ã£ãŸã‚Šã—ãŸã®ã§ã€çµ„ã¿åˆã‚ã›ãŸæ§‹æˆã‚‚è©¦ã—ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚

https://supabase.com/docs/guides/integrations/prisma

# å‚è€ƒ

https://zenn.dev/sora_kumo/articles/0d107b03c58104

https://zenn.dev/razokulover/articles/db984ebfcf4bf6

https://supabase.com/blog/supabase-studio

https://zenn.dev/kuesato/articles/8da958751b52fb

https://zenn.dev/hrtk/articles/supabase-nextjs-local-migration

https://zenn.dev/matken/articles/invite-user-with-supabase

https://zenn.dev/thim/articles/3d98b275df79939a003b
